import{_ as Z}from"./index-481431e1.js";const _=window.Vue.createElementVNode,r=window.Vue.resolveComponent,l=window.Vue.createVNode,o=window.Vue.withCtx,ee=window.Vue.renderList,te=window.Vue.Fragment,i=window.Vue.openBlock,k=window.Vue.createElementBlock,g=window.Vue.createBlock,F=window.Vue.toDisplayString,p=window.Vue.createCommentVNode,M=window.Vue.createTextVNode,le={key:0,class:"file-name"},oe={key:0,class:"media-preview"},ae=["src"],ne={key:0,class:"file-name"},ue=["src"],a=window.Vue.ref,re=window.Vue.onMounted,se={__name:"Upload",setup(de){const N="https://render.setwhat.dpdns.org",n=a({title:"",description:"",categoryId:""}),L=a([]),w=a(null),V=a(null),h=a(""),y=a(""),U=a(!1),C=a(""),m=a(""),f=a(null),x=a(0),I=a(0),E=a(!1),R=a(0),B=a(!1),D=a(0);re(async()=>{const e=await(await fetch(`${N}/api/categories`)).json();(e.code===0||e.code===200)&&(L.value=(e.data||e).map(u=>({text:u.name,value:u.id})))});function q(t){return t.type.startsWith("video/")?(t.size>100*1024*1024&&alert("视频大小不能超过100MB"),!1):(alert("请上传视频文件"),!1)}function z(t){t&&(w.value=t.raw,h.value=t.name,C.value=URL.createObjectURL(t.raw))}function O(t){return t.type.startsWith("image/")||alert("请上传图片文件作为封面"),!1}function W(t){if(!t)return;V.value=t.raw,y.value=t.name;const e=new FileReader;e.onload=u=>{m.value=u.target.result},e.readAsDataURL(t.raw)}function H(){f.value&&(x.value=f.value.duration)}function $(){f.value&&(f.value.currentTime=I.value)}function A(){const t=f.value;if(!t)return;const e=document.createElement("canvas");e.width=t.videoWidth,e.height=t.videoHeight,e.getContext("2d").drawImage(t,0,0,e.width,e.height);const c=e.toDataURL("image/jpeg");m.value=c,e.toBlob(v=>{V.value=new File([v],"cover.jpg",{type:"image/jpeg"}),y.value="cover.jpg"},"image/jpeg")}function J(){m.value&&window.open(m.value,"_blank")}function X(t,e,u){return new Promise((c,v)=>{const s=new XMLHttpRequest;s.open("POST",t,!0),s.upload.onprogress=b=>{b.lengthComputable&&u&&u(b.loaded/b.total*100)},s.onload=()=>{s.status>=200&&s.status<300?c(JSON.parse(s.responseText)):v(new Error(s.statusText||"上传失败"))},s.onerror=()=>v(new Error("上传出错")),s.send(e)})}async function G(){if(!n.value.title.trim())return alert("请输入标题");if(!n.value.categoryId)return alert("请选择分类");if(!w.value)return alert("请选择视频");if(w.value.size>100*1024*1024)return alert("视频不能超过100MB");U.value=!0,E.value=!0,B.value=!1,R.value=0,D.value=0;const t=new FormData;t.append("title",n.value.title),t.append("categoryId",n.value.categoryId),t.append("description",n.value.description||""),t.append("videoFile",w.value),V.value&&t.append("coverFile",V.value);try{const e=await X(`${N}/api/admin/videos`,t,u=>{R.value=u});e.code===0||e.code===200?(alert("上传成功"),n.value.title="",n.value.description="",n.value.categoryId="",w.value=null,V.value=null,h.value="",y.value="",C.value="",m.value="",x.value=0,I.value=0,R.value=0):alert(e.message||"上传失败")}catch(e){alert(e.message||"上传出错")}finally{U.value=!1,E.value=!1}}return(t,e)=>{const u=r("el-input"),c=r("el-form-item"),v=r("el-col"),s=r("el-option"),b=r("el-select"),P=r("el-row"),S=r("el-progress"),T=r("el-upload"),K=r("el-slider"),j=r("el-button"),Q=r("el-form"),Y=r("el-card");return i(),g(Y,{class:"upload-page",shadow:"hover"},{default:o(()=>[e[9]||(e[9]=_("div",{class:"page-header"},"上传视频",-1)),l(Q,{model:n.value,"label-width":"80px",class:"upload-form",rules:t.rules,ref:"formRef"},{default:o(()=>[l(P,{gutter:20},{default:o(()=>[l(v,{xs:24,sm:12},{default:o(()=>[l(c,{label:"标题",prop:"title",required:""},{default:o(()=>[l(u,{modelValue:n.value.title,"onUpdate:modelValue":e[0]||(e[0]=d=>n.value.title=d),placeholder:"请输入视频标题"},null,8,["modelValue"])]),_:1})]),_:1}),l(v,{xs:24,sm:12},{default:o(()=>[l(c,{label:"分类",prop:"categoryId",required:""},{default:o(()=>[l(b,{modelValue:n.value.categoryId,"onUpdate:modelValue":e[1]||(e[1]=d=>n.value.categoryId=d),placeholder:"请选择分类"},{default:o(()=>[(i(!0),k(te,null,ee(L.value,d=>(i(),g(s,{key:d.value,label:d.text,value:d.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(c,{label:"描述"},{default:o(()=>[l(u,{type:"textarea",modelValue:n.value.description,"onUpdate:modelValue":e[2]||(e[2]=d=>n.value.description=d),placeholder:"可选：视频简介",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1}),l(P,{gutter:20},{default:o(()=>[l(v,{xs:24,sm:12},{default:o(()=>[l(c,{label:"视频文件",prop:"videoFile",required:""},{default:o(()=>[l(T,{class:"upload-block",drag:"","show-file-list":!1,"before-upload":q,"on-change":z,"auto-upload":!1,accept:"video/*"},{default:o(()=>[e[4]||(e[4]=_("i",{class:"el-icon-upload"},null,-1)),e[5]||(e[5]=_("div",{class:"el-upload__text"},"拖拽或点击上传视频",-1)),h.value?(i(),k("div",le,"文件名："+F(h.value),1)):p("",!0),E.value?(i(),g(S,{key:1,percentage:R.value},null,8,["percentage"])):p("",!0)]),_:1,__:[4,5]}),C.value?(i(),k("div",oe,[_("video",{ref_key:"videoElement",ref:f,src:C.value,controls:"",class:"video-thumb",onLoadedmetadata:H},null,40,ae),x.value>0?(i(),g(K,{key:0,modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=d=>I.value=d),min:0,max:x.value,step:.1,onInput:$,style:{"margin-top":"10px"}},null,8,["modelValue","max"])):p("",!0),x.value>0?(i(),g(j,{key:1,size:"small",onClick:A,style:{"margin-top":"10px"}},{default:o(()=>e[6]||(e[6]=[M("截取封面")])),_:1,__:[6]})):p("",!0)])):p("",!0)]),_:1})]),_:1}),l(v,{xs:24,sm:12},{default:o(()=>[l(c,{label:"封面图片"},{default:o(()=>[l(T,{class:"upload-block",drag:"","show-file-list":!1,"before-upload":O,"on-change":W,"auto-upload":!1,accept:"image/*"},{default:o(()=>[e[7]||(e[7]=_("i",{class:"el-icon-picture"},null,-1)),e[8]||(e[8]=_("div",{class:"el-upload__text"},"拖拽或点击上传封面",-1)),y.value?(i(),k("div",ne,"封面名："+F(y.value),1)):p("",!0),B.value?(i(),g(S,{key:1,percentage:D.value},null,8,["percentage"])):p("",!0)]),_:1,__:[7,8]}),m.value?(i(),k("div",{key:0,class:"media-preview",onClick:J},[_("img",{src:m.value,class:"img-thumb"},null,8,ue)])):p("",!0)]),_:1})]),_:1})]),_:1}),l(c,null,{default:o(()=>[l(j,{type:"primary",loading:U.value,onClick:G,style:{width:"100%"}},{default:o(()=>[M(F(U.value?"上传中...":"上传"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"])]),_:1,__:[9]})}}},ce=Z(se,[["__scopeId","data-v-f62dee9b"]]);export{ce as default};
