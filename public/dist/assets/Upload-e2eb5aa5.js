import{_ as Z}from"./index-dfe38df9.js";const y=window.Vue.createElementVNode,d=window.Vue.resolveComponent,o=window.Vue.createVNode,n=window.Vue.withCtx,ee=window.Vue.renderList,te=window.Vue.Fragment,p=window.Vue.openBlock,U=window.Vue.createElementBlock,h=window.Vue.createBlock,T=window.Vue.toDisplayString,_=window.Vue.createCommentVNode,D=window.Vue.createTextVNode,le={key:0,class:"file-name"},ae={key:0,class:"media-preview"},oe=["src"],ne={key:0,class:"file-name"},ue=["src"],r=window.Vue.ref,re=window.Vue.onMounted,se={__name:"Upload",setup(ie){const I="https://render.setwhat.dpdns.org",u=r({title:"",description:"",categoryId:""}),j=r([]),f=r(null),k=r(null),v=r(""),x=r(""),N=r(!1),R=r(""),g=r(""),V=r(null),b=r(0),F=r(0),M=r(!1),C=r(0),E=r(!1),B=r(0);re(async()=>{const e=await(await fetch(`${I}/api/categories`)).json();(e.code===0||e.code===200)&&(j.value=(e.data||e).map(a=>({text:a.name,value:a.id})))});function O(t){return t.type.startsWith("video/")?(t.size>2e3*1024*1024&&alert("视频大小不能超过2000MB"),!1):(alert("请上传视频文件"),!1)}function $(t){t&&(f.value=t.raw,v.value=t.name,R.value=URL.createObjectURL(t.raw))}function q(t){return t.type.startsWith("image/")||alert("请上传图片文件作为封面"),!1}function W(t){if(!t)return;k.value=t.raw,x.value=t.name;const e=new FileReader;e.onload=a=>{g.value=a.target.result},e.readAsDataURL(t.raw)}function H(){V.value&&(b.value=V.value.duration)}function J(){V.value&&(V.value.currentTime=F.value)}function A(){const t=V.value;if(!t)return;const e=document.createElement("canvas");e.width=t.videoWidth,e.height=t.videoHeight,e.getContext("2d").drawImage(t,0,0,e.width,e.height);const l=e.toDataURL("image/jpeg");g.value=l,e.toBlob(s=>{k.value=new File([s],"cover.jpg",{type:"image/jpeg"}),x.value="cover.jpg"},"image/jpeg")}function X(){g.value&&window.open(g.value,"_blank")}function P(t,e,a){return new Promise((l,s)=>{const i=new XMLHttpRequest;i.open("POST",t,!0),i.upload.onprogress=w=>{w.lengthComputable&&a&&a(w.loaded/w.total*100)},i.onload=()=>{i.status>=200&&i.status<300?l(JSON.parse(i.responseText)):s(new Error(i.statusText||"上传失败"))},i.onerror=()=>s(new Error("上传出错")),i.send(e)})}async function G(){if(!u.value.title.trim())return alert("请输入标题");if(!u.value.categoryId)return alert("请选择分类");if(!f.value)return alert("请选择视频");if(f.value.size>2e3*1024*1024)return alert("视频不能超过2000MB");N.value=!0,M.value=!0,E.value=!1,C.value=0,B.value=0;const t=5*1024*1024,e=Math.ceil(f.value.size/t);try{for(let l=0;l<e;l++){const s=l*t,i=Math.min(f.value.size,s+t),w=f.value.slice(s,i),m=new FormData;m.append("file",w,`${v.value}.part${l}`),m.append("chunkIndex",l),m.append("totalChunks",e),m.append("fileName",v.value),await P(`${I}/api/admin/videos/chunk`,m,L=>{const S=(l+L/100)/e*100;C.value=Math.min(100,Math.floor(S))})}let a;if(k.value){const l=new FormData;l.append("file",k.value),l.append("fileName",v.value),l.append("totalChunks",e),l.append("title",u.value.title),l.append("description",u.value.description||""),l.append("categoryId",u.value.categoryId),a=await P(`${I}/api/admin/videos/merge`,l,s=>{E.value=!0,B.value=s})}else a=await(await fetch(`${I}/api/admin/videos/merge`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:v.value,totalChunks:e,title:u.value.title,description:u.value.description||"",categoryId:u.value.categoryId})})).json();a.code===0||a.code===200?(C.value=100,alert("上传成功"),u.value.title="",u.value.description="",u.value.categoryId="",f.value=null,k.value=null,v.value="",x.value="",R.value="",g.value="",b.value=0,F.value=0,C.value=0,B.value=0,E.value=!1):alert(a.message||"分片合并失败")}catch(a){alert(a.message||"上传出错")}finally{N.value=!1,M.value=!1}}return(t,e)=>{const a=d("el-input"),l=d("el-form-item"),s=d("el-col"),i=d("el-option"),w=d("el-select"),m=d("el-row"),L=d("el-progress"),S=d("el-upload"),K=d("el-slider"),z=d("el-button"),Q=d("el-form"),Y=d("el-card");return p(),h(Y,{class:"upload-page",shadow:"hover"},{default:n(()=>[e[9]||(e[9]=y("div",{class:"page-header"},"上传视频",-1)),o(Q,{model:u.value,"label-width":"80px",class:"upload-form",rules:t.rules,ref:"formRef"},{default:n(()=>[o(m,{gutter:20},{default:n(()=>[o(s,{xs:24,sm:12},{default:n(()=>[o(l,{label:"标题",prop:"title",required:""},{default:n(()=>[o(a,{modelValue:u.value.title,"onUpdate:modelValue":e[0]||(e[0]=c=>u.value.title=c),placeholder:"请输入视频标题"},null,8,["modelValue"])]),_:1})]),_:1}),o(s,{xs:24,sm:12},{default:n(()=>[o(l,{label:"分类",prop:"categoryId",required:""},{default:n(()=>[o(w,{modelValue:u.value.categoryId,"onUpdate:modelValue":e[1]||(e[1]=c=>u.value.categoryId=c),placeholder:"请选择分类"},{default:n(()=>[(p(!0),U(te,null,ee(j.value,c=>(p(),h(i,{key:c.value,label:c.text,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(l,{label:"描述"},{default:n(()=>[o(a,{type:"textarea",modelValue:u.value.description,"onUpdate:modelValue":e[2]||(e[2]=c=>u.value.description=c),placeholder:"可选：视频简介",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1}),o(m,{gutter:20},{default:n(()=>[o(s,{xs:24,sm:12},{default:n(()=>[o(l,{label:"视频文件",prop:"videoFile",required:""},{default:n(()=>[o(S,{class:"upload-block",drag:"","show-file-list":!1,"before-upload":O,"on-change":$,"auto-upload":!1,accept:"video/*"},{default:n(()=>[e[4]||(e[4]=y("i",{class:"el-icon-upload"},null,-1)),e[5]||(e[5]=y("div",{class:"el-upload__text"},"拖拽或点击上传视频",-1)),v.value?(p(),U("div",le,"文件名："+T(v.value),1)):_("",!0),M.value?(p(),h(L,{key:1,percentage:C.value},null,8,["percentage"])):_("",!0)]),_:1,__:[4,5]}),R.value?(p(),U("div",ae,[y("video",{ref_key:"videoElement",ref:V,src:R.value,controls:"",class:"video-thumb",onLoadedmetadata:H},null,40,oe),b.value>0?(p(),h(K,{key:0,modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=c=>F.value=c),min:0,max:b.value,step:.1,onInput:J,style:{"margin-top":"10px"}},null,8,["modelValue","max"])):_("",!0),b.value>0?(p(),h(z,{key:1,size:"small",onClick:A,style:{"margin-top":"10px"}},{default:n(()=>e[6]||(e[6]=[D("截取封面")])),_:1,__:[6]})):_("",!0)])):_("",!0)]),_:1})]),_:1}),o(s,{xs:24,sm:12},{default:n(()=>[o(l,{label:"封面图片"},{default:n(()=>[o(S,{class:"upload-block",drag:"","show-file-list":!1,"before-upload":q,"on-change":W,"auto-upload":!1,accept:"image/*"},{default:n(()=>[e[7]||(e[7]=y("i",{class:"el-icon-picture"},null,-1)),e[8]||(e[8]=y("div",{class:"el-upload__text"},"拖拽或点击上传封面",-1)),x.value?(p(),U("div",ne,"封面名："+T(x.value),1)):_("",!0),E.value?(p(),h(L,{key:1,percentage:B.value},null,8,["percentage"])):_("",!0)]),_:1,__:[7,8]}),g.value?(p(),U("div",{key:0,class:"media-preview",onClick:X},[y("img",{src:g.value,class:"img-thumb"},null,8,ue)])):_("",!0)]),_:1})]),_:1})]),_:1}),o(l,null,{default:n(()=>[o(z,{type:"primary",loading:N.value,onClick:G,style:{width:"100%"}},{default:n(()=>[D(T(N.value?"上传中...":"上传"),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["model","rules"])]),_:1,__:[9]})}}},ce=Z(se,[["__scopeId","data-v-97e93108"]]);export{ce as default};
