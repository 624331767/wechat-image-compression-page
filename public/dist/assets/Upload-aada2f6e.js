import{_ as pe}from"./index-c35380f5.js";const R=window.Vue.createTextVNode,o=window.Vue.unref,n=window.Vue.withCtx,r=window.Vue.createVNode,w=window.Vue.createElementVNode,c=window.Vue.openBlock,V=window.Vue.createBlock,f=window.Vue.createCommentVNode,W=window.Vue.resolveComponent,we=window.Vue.renderList,X=window.Vue.Fragment,h=window.Vue.createElementBlock,D=window.Vue.toDisplayString,fe={class:"header-bar"},ge={key:1,class:"video-info"},_e={class:"file-name"},ye={key:1,class:"upload-status"},he={key:2,class:"media-preview"},Ee=["src"],ke={key:0,class:"file-name"},be=["src"],xe={class:"dialog-content"},Ve=["src"],s=window.Vue.ref,Pe=window.Vue.onMounted;window.Vue.nextTick;const T=window.ElementPlus.ElButton,Ue=window.ElementPlus.ElForm,F=window.ElementPlus.ElFormItem,K=window.ElementPlus.ElInput,Ce=window.ElementPlus.ElSelect,Fe=window.ElementPlus.ElOption,Q=window.ElementPlus.ElUpload,Y=window.ElementPlus.ElProgress,Me=window.ElementPlus.ElSlider,Re=window.ElementPlus.ElAlert,Se=window.ElementPlus.ElDialog,d=window.ElementPlus.ElMessage,Be=window.ElementPlus.ElMessageBox,Ne={__name:"Upload",setup(Ie){const S="https://render.setwhat.dpdns.org",m=s({title:"",description:"",categoryId:"",videoFile:null}),$=s([]),v=s(null),P=s(null),E=s(""),U=s(""),C=s(!1),B=s(!1),g=s(""),_=s(""),y=s(null),k=s(0),b=s(0),N=s(!1),x=s(!1),I=s(0),O=s(""),M=s(!1),z=s(0),L=s(null),Z=s({title:[{required:!0,message:"请输入视频标题",trigger:"blur"},{max:100,message:"标题不能超过100个字符",trigger:"blur"}],categoryId:[{required:!0,message:"请选择视频分类",trigger:"change"}],videoFile:[{required:!0,message:"请选择视频文件",trigger:"change"}]});Pe(async()=>{try{$.value=[{text:"科技",value:"1"},{text:"娱乐",value:"2"},{text:"教育",value:"3"}];const l=await fetch(`${S}/api/categories`);if(!l.ok)throw new Error("获取分类失败");const e=await l.json();if(e.code===0||e.code===200)$.value=(e.data||e).map(t=>({text:t.name,value:t.id}));else throw new Error(e.message||"分类数据格式错误")}catch(l){d.error(l.message)}});function ee(l){return l.type.startsWith("video/")?(l.size>2e3*1024*1024&&d.error("视频大小不能超过2000MB"),!1):(d.error("请上传视频文件"),!1)}function le(l){!l||!l.raw||(v.value=l.raw,E.value=l.name||"未命名视频",g.value=URL.createObjectURL(l.raw),m.value.videoFile=l.raw,A())}function te(){g.value&&URL.revokeObjectURL(g.value),v.value=null,E.value="",g.value="",k.value=0,b.value=0,m.value.videoFile=null,A(),d.info("视频已移除")}function A(){_.value="",P.value=null,U.value=""}async function ae(){if(y.value)try{k.value=y.value.duration||0,b.value=0;const l=k.value>5?5:1;await new Promise(e=>{const t=()=>{y.value.readyState>=2?e():setTimeout(t,100)};t()}),y.value.currentTime=l,await new Promise(e=>setTimeout(e,300)),await q(!1),d.success(`已自动截取${l}秒处作为封面`)}catch(l){d.warning("自动截取封面失败，请手动截取")}}function oe(l){return l.type.startsWith("image/")||d.error("请上传图片文件作为封面"),!1}function ne(l){if(!l||!l.raw)return;P.value=l.raw,U.value=l.name||"未命名图片";const e=new FileReader;e.onload=t=>{_.value=t.target.result},e.readAsDataURL(l.raw)}function re(){y.value&&!isNaN(b.value)&&(y.value.currentTime=b.value)}function q(l=!0){return new Promise((e,t)=>{const i=y.value;if(!i){const u=new Error("视频元素不存在");return l&&d.warning("请先上传视频"),t(u)}try{const u=document.createElement("canvas"),p=Math.min(1280/i.videoWidth,1);u.width=i.videoWidth*p,u.height=i.videoHeight*p,u.getContext("2d").drawImage(i,0,0,u.width,u.height);const j=u.toDataURL("image/jpeg");_.value=j,u.toBlob(H=>{if(H)P.value=new File([H],"cover.jpg",{type:"image/jpeg"}),U.value="cover.jpg",l&&d.success("封面截取成功"),e();else{const me=new Error("无法生成封面图片");l&&d.error("封面截取失败"),t(me)}},"image/jpeg")}catch(u){l&&d.error("封面截取失败"),t(u)}})}function se(){_.value?N.value=!0:d.warning("暂无封面可预览")}function ue(){window.history.back()}function J(l,e,t){return new Promise((i,u)=>{const a=new XMLHttpRequest;a.open("POST",l,!0),a.upload.onprogress=p=>{p.lengthComputable&&t&&t(p.loaded/p.total*100)},a.onload=()=>{if(a.status>=200&&a.status<300)try{i(JSON.parse(a.responseText))}catch{i({code:200,message:"上传成功"})}else u(new Error(`上传失败 (${a.status})`))},a.onerror=()=>u(new Error("网络错误，上传失败")),a.send(e)})}async function ie(){if(!v.value)throw new Error("视频文件不存在");const l=5*1024*1024,e=Math.ceil(v.value.size/l);for(let t=0;t<e;t++){O.value=`正在上传分片 ${t+1}/${e}`;const i=t*l,u=Math.min(v.value.size,i+l),a=v.value.slice(i,u),p=new FormData;p.append("file",a,`${E.value}.part${t}`),p.append("chunkIndex",t),p.append("totalChunks",e),p.append("fileName",E.value),await J(`${S}/api/admin/videos/chunk`,p,G=>{const j=(t+G/100)/e*100;I.value=Math.min(100,Math.floor(j))})}}async function de(){if(!v.value)throw new Error("视频文件不存在");const l={fileName:E.value,totalChunks:Math.ceil(v.value.size/(5*1024*1024)),title:m.value.title,description:m.value.description||"",categoryId:m.value.categoryId};let e;if(P.value){const t=new FormData;Object.entries(l).forEach(([i,u])=>{t.append(i,u)}),t.append("file",P.value),e=await J(`${S}/api/admin/videos/merge`,t,i=>{M.value=!0,z.value=i})}else{const t=await fetch(`${S}/api/admin/videos/merge`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!t.ok)throw new Error("合并请求失败");e=await t.json().catch(()=>({code:200}))}if(![0,200].includes(e.code))throw new Error(e.message||"分片合并失败");return e}function ce(){m.value={title:"",description:"",categoryId:"",videoFile:null},g.value&&URL.revokeObjectURL(g.value),v.value=null,P.value=null,E.value="",U.value="",g.value="",_.value="",k.value=0,b.value=0,I.value=0,z.value=0,x.value=!1,M.value=!1,O.value="",N.value=!1,L.value?.resetFields()}async function ve(){if(!L.value)return;let l;try{await L.value.validate(),l=!0}catch{l=!1;return}if(l){if(!v.value){d.error("请选择视频文件");return}if(v.value.size>2e3*1024*1024){d.error("视频大小不能超过2000MB");return}if(v.value.size>100*1024*1024)try{await Be.confirm(`视频大小约 ${(v.value.size/(1024*1024)).toFixed(1)}MB，上传可能需要较长时间，是否继续？`,"确认上传")}catch{return}C.value=!0,x.value=!0,B.value=!1;try{await ie(),await de(),I.value=100,d.success("视频上传成功！"),B.value=!0,ce(),window.scrollTo({top:0,behavior:"smooth"})}catch(e){d.error("上传失败："+e.message)}finally{C.value=!1,x.value=!1,M.value=!1}}}return(l,e)=>{const t=W("el-col"),i=W("el-row"),u=W("el-card");return c(),h(X,null,[r(u,{class:"upload-page",shadow:"hover"},{default:n(()=>[w("div",fe,[r(o(T),{type:"text",icon:"el-icon-back",onClick:ue,class:"back-btn"},{default:n(()=>e[6]||(e[6]=[R(" 返回 ")])),_:1,__:[6]}),e[7]||(e[7]=w("div",{class:"page-title"},"上传视频",-1))]),B.value?(c(),V(o(Re),{key:0,title:"上传成功！",type:"success",closable:"",onClose:e[0]||(e[0]=a=>B.value=!1),style:{"margin-bottom":"20px"}})):f("",!0),r(o(Ue),{model:m.value,"label-width":"80px",class:"upload-form",rules:Z.value,ref_key:"formRef",ref:L,disabled:C.value},{default:n(()=>[r(i,{gutter:20},{default:n(()=>[r(t,{xs:24,sm:12},{default:n(()=>[r(o(F),{label:"标题",prop:"title"},{default:n(()=>[r(o(K),{modelValue:m.value.title,"onUpdate:modelValue":e[1]||(e[1]=a=>m.value.title=a),placeholder:"请输入视频标题"},null,8,["modelValue"])]),_:1})]),_:1}),r(t,{xs:24,sm:12},{default:n(()=>[r(o(F),{label:"分类",prop:"categoryId"},{default:n(()=>[r(o(Ce),{modelValue:m.value.categoryId,"onUpdate:modelValue":e[2]||(e[2]=a=>m.value.categoryId=a),placeholder:"请选择分类"},{default:n(()=>[(c(!0),h(X,null,we($.value,a=>(c(),V(o(Fe),{key:a.value,label:a.text,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),r(o(F),{label:"描述"},{default:n(()=>[r(o(K),{type:"textarea",modelValue:m.value.description,"onUpdate:modelValue":e[3]||(e[3]=a=>m.value.description=a),placeholder:"可选：视频简介",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1}),r(i,{gutter:20},{default:n(()=>[r(t,{xs:24,sm:12},{default:n(()=>[r(o(F),{label:"视频文件",prop:"videoFile"},{default:n(()=>[v.value?(c(),h("div",ge,[w("div",_e,[R(" 已选文件："+D(E.value)+" ",1),r(o(T),{type:"text",icon:"el-icon-delete",class:"remove-btn",onClick:te},{default:n(()=>e[9]||(e[9]=[R(" 移除 ")])),_:1,__:[9]})]),x.value?(c(),V(o(Y),{key:0,percentage:I.value,"stroke-width":"3",style:{margin:"10px 0"}},null,8,["percentage"])):f("",!0),x.value?(c(),h("div",ye,D(O.value),1)):f("",!0),g.value?(c(),h("div",he,[w("video",{ref_key:"videoElement",ref:y,src:g.value,controls:"",class:"video-thumb",onLoadedmetadata:ae},null,40,Ee),k.value>0?(c(),V(o(Me),{key:0,modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=a=>b.value=a),min:0,max:k.value,step:.1,onInput:re,style:{"margin-top":"10px"}},null,8,["modelValue","max"])):f("",!0),k.value>0?(c(),V(o(T),{key:1,size:"small",onClick:q,style:{"margin-top":"10px"},type:"primary"},{default:n(()=>e[10]||(e[10]=[R(" 重新截取封面 ")])),_:1,__:[10]})):f("",!0)])):f("",!0)])):(c(),V(o(Q),{key:0,class:"upload-block",drag:"","show-file-list":!1,"before-upload":ee,"on-change":le,"auto-upload":!1,accept:"video/*",disabled:x.value},{default:n(()=>e[8]||(e[8]=[w("i",{class:"el-icon-upload"},null,-1),w("div",{class:"el-upload__text"},"拖拽或点击上传视频",-1),w("div",{class:"el-upload__hint"},"支持 MP4、WebM 等格式，最大 2000MB",-1)])),_:1,__:[8]},8,["disabled"]))]),_:1})]),_:1}),r(t,{xs:24,sm:12},{default:n(()=>[r(o(F),{label:"封面图片"},{default:n(()=>[r(o(Q),{class:"upload-block",drag:"","show-file-list":!1,"before-upload":oe,"on-change":ne,"auto-upload":!1,accept:"image/*",disabled:M.value||x.value},{default:n(()=>[e[11]||(e[11]=w("i",{class:"el-icon-picture"},null,-1)),e[12]||(e[12]=w("div",{class:"el-upload__text"},"拖拽或点击上传封面",-1)),e[13]||(e[13]=w("div",{class:"el-upload__hint"},"支持 JPG、PNG 格式，建议比例 16:9",-1)),U.value?(c(),h("div",ke,"已选封面："+D(U.value),1)):f("",!0),M.value?(c(),V(o(Y),{key:1,percentage:z.value,"stroke-width":"3"},null,8,["percentage"])):f("",!0)]),_:1,__:[11,12,13]},8,["disabled"]),_.value?(c(),h("div",{key:0,class:"media-preview",onClick:se,style:{cursor:"pointer"}},[w("img",{src:_.value,class:"img-thumb"},null,8,be),e[14]||(e[14]=w("div",{class:"preview-tip"},"点击预览大图",-1))])):f("",!0)]),_:1})]),_:1})]),_:1}),r(o(F),null,{default:n(()=>[r(o(T),{type:"primary",loading:C.value,onClick:ve,style:{width:"100%"},disabled:C.value},{default:n(()=>[R(D(C.value?"上传中...":"上传"),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1},8,["model","rules","disabled"])]),_:1}),r(o(Se),{title:"封面预览",modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=a=>N.value=a),modal:!0,"close-on-click-modal":!0,width:"80%","max-width":"800px"},{default:n(()=>[w("div",xe,[_.value?(c(),h("img",{key:0,src:_.value,class:"preview-img",alt:"封面预览"},null,8,Ve)):f("",!0)])]),_:1},8,["modelValue"])],64)}}},De=pe(Ne,[["__scopeId","data-v-1b84159c"]]);export{De as default};
