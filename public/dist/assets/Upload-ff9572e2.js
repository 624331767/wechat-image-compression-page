import{_ as Ue}from"./index-7ca7aa2a.js";const T=window.Vue.createTextVNode,t=window.Vue.unref,n=window.Vue.withCtx,a=window.Vue.createVNode,o=window.Vue.createElementVNode,m=window.Vue.openBlock,D=window.Vue.createBlock,_=window.Vue.createCommentVNode,ae=window.Vue.resolveComponent,Fe=window.Vue.renderList,Se=window.Vue.Fragment,E=window.Vue.createElementBlock,R=window.Vue.toDisplayString,$e=window.Vue.normalizeClass,Me={class:"upload-container"},Re={class:"header-bar"},ze={class:"form-section"},Be={class:"section-title"},Te={class:"form-section"},De={class:"section-title"},Ne={key:0,class:"upload-area"},Le={class:"upload-content"},je={class:"upload-tips"},Oe={key:1,class:"video-selected"},We={class:"file-header"},Ae={class:"file-info"},Ke={class:"file-details"},qe={class:"file-name"},Je={class:"file-size"},Ge={key:0,class:"upload-progress-section"},He={class:"progress-info"},Ze={key:0,class:"time-text"},Xe={key:1,class:"video-preview-section"},Qe=["src"],Ye={key:0,class:"video-controls"},el={class:"time-display"},ll={class:"form-section"},tl={class:"section-title"},ol={class:"cover-upload-section"},al={key:0,class:"cover-upload-area"},sl={class:"cover-upload-content"},nl={key:0,class:"cover-tip"},il={key:1,class:"cover-preview-section"},rl=["src"],ul={class:"cover-overlay"},dl={class:"cover-actions"},cl={class:"form-actions"},vl={key:0,class:"upload-tips-info"},pl={class:"dialog-content"},ml=["src"],u=window.Vue.ref,wl=window.Vue.onMounted,fl=window.Vue.computed,N=window.ElementPlus.ElButton,gl=window.ElementPlus.ElForm,Q=window.ElementPlus.ElFormItem,se=window.ElementPlus.ElInput,_l=window.ElementPlus.ElSelect,hl=window.ElementPlus.ElOption,ne=window.ElementPlus.ElUpload,El=window.ElementPlus.ElProgress,yl=window.ElementPlus.ElSlider,Vl=window.ElementPlus.ElAlert,kl=window.ElementPlus.ElDialog,g=window.ElementPlus.ElMessage,Pl=window.ElementPlus.ElMessageBox,k=window.ElementPlus.ElIcon,ie=window.ElementPlus.ElTag,bl=window.ElementPlus.ElCard;window.ElementPlusIconsVue.ArrowLeft;const Cl=window.ElementPlusIconsVue.Document,Il=window.ElementPlusIconsVue.Edit,re=window.ElementPlusIconsVue.VideoCamera,xl=window.ElementPlusIconsVue.UploadFilled,ue=window.ElementPlusIconsVue.InfoFilled,de=window.ElementPlusIconsVue.Delete,ce=window.ElementPlusIconsVue.Camera,ve=window.ElementPlusIconsVue.Picture,Ul=window.ElementPlusIconsVue.Warning,Fl=window.ElementPlusIconsVue.ZoomIn,Sl=window.ElementPlusIconsVue.Upload,$l={__name:"Upload",setup(Ml){const z="https://render.setwhat.dpdns.org",w=u({title:"",description:"",categoryId:"",videoFile:null}),Y=u([]),c=u(null),M=u(null),B=u(""),A=u(""),x=u(!1),K=u(!1),b=u(""),y=u(""),U=u(null),F=u(0),S=u(0),q=u(!1),C=u(!1),L=u(0),I=u(""),J=u(!1),ee=u(0),j=u(!1),le=u("");u(0);const G=u(null),pe=fl(()=>w.value.title&&w.value.categoryId&&c.value&&!x),me=u({title:[{required:!0,message:"请输入视频标题",trigger:"blur"},{max:100,message:"标题不能超过100个字符",trigger:"blur"}],categoryId:[{required:!0,message:"请选择视频分类",trigger:"change"}],videoFile:[{required:!0,message:"请选择视频文件",trigger:"change"}]});function we(l){if(l===0)return"0 B";const e=1024,r=["B","KB","MB","GB"],d=Math.floor(Math.log(l)/Math.log(e));return Math.round(l/Math.pow(e,d)*100)/100+" "+r[d]}function te(l){if(!l||isNaN(l))return"00:00";const e=Math.floor(l/60),r=Math.floor(l%60);return`${String(e).padStart(2,"0")}:${String(r).padStart(2,"0")}`}wl(async()=>{try{const l=await fetch(`${z}/api/categories`);if(!l.ok)throw new Error("获取分类失败");const e=await l.json();if(e.code===0||e.code===200)Y.value=(e.data||e).map(r=>({text:r.name,value:r.id}));else throw new Error(e.message||"分类数据格式错误")}catch(l){g.error(l.message)}});function fe(l){return l.type.startsWith("video/")?(l.size>5e3*1024*1024&&g.error("视频大小不能超过5000MB"),!1):(g.error("请上传视频文件"),!1)}function ge(l){!l||!l.raw||(c.value=l.raw,B.value=l.name||"未命名视频",b.value=URL.createObjectURL(l.raw),w.value.videoFile=l.raw,Z())}function _e(){b.value&&URL.revokeObjectURL(b.value),c.value=null,B.value="",b.value="",F.value=0,S.value=0,w.value.videoFile=null,Z(),g.info("视频已移除")}function Z(){y.value="",M.value=null,A.value=""}async function he(){if(U.value)try{F.value=U.value.duration||0,S.value=0;const l=F.value>5?5:1;await new Promise(e=>{const r=()=>{U.value.readyState>=2?e():setTimeout(r,100)};r()}),U.value.currentTime=l,await new Promise(e=>setTimeout(e,300)),y.value||(await X(!1),g.success(`已自动截取${l}秒处作为封面`))}catch(l){}}function Ee(l){return l.type.startsWith("image/")||g.error("请上传图片文件作为封面"),!1}function ye(l){if(!l||!l.raw)return;M.value=l.raw,A.value=l.name||"未命名图片";const e=new FileReader;e.onload=r=>{y.value=r.target.result},e.readAsDataURL(l.raw)}function Ve(){U.value&&!isNaN(S.value)&&(U.value.currentTime=S.value)}function X(l=!0){return new Promise((e,r)=>{const d=U.value;if(!d){const s=new Error("视频元素不存在");return l&&g.warning("请先上传视频"),r(s)}try{const s=document.createElement("canvas"),p=Math.min(1280/d.videoWidth,1);s.width=d.videoWidth*p,s.height=d.videoHeight*p,s.getContext("2d").drawImage(d,0,0,s.width,s.height);const O=s.toDataURL("image/jpeg");y.value=O,s.toBlob(W=>{if(W)M.value=new File([W],"cover.jpg",{type:"image/jpeg"}),A.value="cover.jpg",l&&g.success("封面截取成功"),e();else{const i=new Error("无法生成封面图片");l&&g.error("封面截取失败"),r(i)}},"image/jpeg")}catch(s){l&&g.error("封面截取失败"),r(s)}})}function ke(){y.value?q.value=!0:g.warning("暂无封面可预览")}function Pe(){window.history.back()}function oe(l,e,r){return new Promise((d,s)=>{const v=new XMLHttpRequest;v.open("POST",l,!0),v.upload.onprogress=p=>{p.lengthComputable&&r&&r(p.loaded/p.total*100)},v.onload=()=>{if(v.status>=200&&v.status<300)try{d(JSON.parse(v.responseText))}catch{d({code:200,message:"上传成功"})}else s(new Error(`上传失败 (${v.status})`))},v.onerror=()=>s(new Error("网络错误，上传失败")),v.send(e)})}async function be(){if(!c.value)throw new Error("视频文件不存在");const l=10*1024*1024,e=Math.ceil(c.value.size/l),r=3;let d=null,s=null;const v=new Set;let p=0,h=[];I.value="正在初始化上传...";try{const i=await fetch(`${z}/api/admin/videos/init-upload`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:B.value,contentType:c.value.type||"video/mp4",totalChunks:e})});if(!i.ok){const P=await i.json().catch(()=>({}));throw new Error(P.message||"初始化上传失败")}const f=await i.json();if(f.code!==200&&f.code!==0)throw new Error(f.message||"初始化上传失败");d=f.data.uploadId,s=f.data.fileKey}catch(i){throw new Error(`初始化上传失败: ${i.message}`)}I.value="正在检查已上传的分片...";try{const i=await fetch(`${z}/api/admin/videos/chunks-check?fileKey=${encodeURIComponent(s)}&uploadId=${encodeURIComponent(d)}`);if(i.ok){const f=await i.json();if(f.code===200||f.code===0){const P=f.data.uploadedChunks||[];P.forEach(V=>{v.add(V),p++}),P.length>0&&(I.value=`发现 ${P.length} 个已上传的分片，将跳过`)}}}catch(i){}const O=()=>{L.value=Math.min(100,Math.floor(p/e*100)),I.value=`已完成 ${p}/${e} 分片上传`},W=async i=>{if(v.has(i)){`${i}`;return}const f=i*l,P=Math.min(c.value.size,f+l),V=c.value.slice(f,P),$=new FormData;$.append("file",V,`${B.value}.part${i}`),$.append("chunkIndex",i),$.append("totalChunks",e),$.append("fileKey",s),$.append("uploadId",d);try{const H=await oe(`${z}/api/admin/videos/chunk`,$,()=>{});H.data&&H.data.skipped&&`${i}`,v.add(i),p++,O()}catch(H){`${i}`,h.push(i)}};for(let i=0;i<e;i+=r){const f=[];for(let V=0;V<r&&i+V<e;V++)f.push(W(i+V));await Promise.all(f);let P=0;for(;h.length>0&&P<3;){P++;const V=[...h];h=[],I.value=`正在重试 ${V.length} 个失败的分片...`,await Promise.all(V.map($=>W($)))}if(h.length>0)throw new Error(`${h.length} 个分片上传失败，请重试`)}return{uploadId:d,fileKey:s,totalChunks:e}}async function Ce(l){if(!c.value)throw new Error("视频文件不存在");const{uploadId:e,fileKey:r,totalChunks:d}=l,s={fileKey:r,uploadId:e,totalChunks:d,title:w.value.title,description:w.value.description||"",categoryId:w.value.categoryId};let v;if(M.value){const p=new FormData;Object.entries(s).forEach(([h,O])=>{p.append(h,O)}),p.append("file",M.value),v=await oe(`${z}/api/admin/videos/merge`,p,h=>{J.value=!0,ee.value=h})}else{const p=await fetch(`${z}/api/admin/videos/merge`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!p.ok){const h=await p.json().catch(()=>({}));throw new Error(h.message||"合并请求失败")}v=await p.json().catch(()=>({code:200}))}if(![0,200].includes(v.code))throw new Error(v.message||"分片合并失败");return v}function Ie(){w.value={title:"",description:"",categoryId:"",videoFile:null},b.value&&URL.revokeObjectURL(b.value),c.value=null,M.value=null,B.value="",A.value="",b.value="",y.value="",F.value=0,S.value=0,L.value=0,ee.value=0,C.value=!1,J.value=!1,I.value="",q.value=!1,G.value?.resetFields()}async function xe(){if(!G.value)return;let l;try{await G.value.validate(),l=!0}catch{l=!1;return}if(l){if(!c.value){g.error("请选择视频文件");return}if(c.value.size>2e3*1024*1024){g.error("视频大小不能超过2000MB");return}if(c.value.size>100*1024*1024)try{await Pl.confirm(`视频大小约 ${(c.value.size/(1024*1024)).toFixed(1)}MB，上传可能需要较长时间。

系统已优化大文件上传功能，支持断点续传和并行上传，请保持网络连接稳定。

是否继续上传？`,"大文件上传提示",{confirmButtonText:"开始上传",cancelButtonText:"取消",type:"info"})}catch{return}x.value=!0,C.value=!0,K.value=!1,j.value=!1;try{const e=await be();I.value="正在合并分片并保存...",await Ce(e),L.value=100,g.success("视频上传成功！"),K.value=!0,Ie(),window.scrollTo({top:0,behavior:"smooth"})}catch(e){j.value=!0,g.error("上传失败："+e.message),I.value=`上传失败: ${e.message}`}finally{x.value=!1,C.value=!1,J.value=!1}}}return(l,e)=>{const r=ae("el-col"),d=ae("el-row");return m(),E("div",Me,[o("div",Re,[a(t(N),{type:"text",icon:"ArrowLeft",onClick:Pe,class:"back-btn",size:"large"},{default:n(()=>e[6]||(e[6]=[T(" 返回 ")])),_:1,__:[6]}),e[7]||(e[7]=o("h1",{class:"page-title"},"上传视频",-1)),e[8]||(e[8]=o("div",{class:"header-placeholder"},null,-1))]),K.value?(m(),D(t(Vl),{key:0,title:"上传成功！",type:"success",closable:!0,onClose:e[0]||(e[0]=s=>K.value=!1),class:"success-alert","show-icon":""})):_("",!0),a(t(bl),{class:"upload-card",shadow:"hover"},{default:n(()=>[a(t(gl),{model:w.value,"label-width":"100px",class:"upload-form",rules:me.value,ref_key:"formRef",ref:G,disabled:x.value},{default:n(()=>[o("div",ze,[o("div",Be,[a(t(k),null,{default:n(()=>[a(t(Cl))]),_:1}),e[9]||(e[9]=o("span",null,"基本信息",-1))]),a(d,{gutter:24},{default:n(()=>[a(r,{xs:24,sm:12},{default:n(()=>[a(t(Q),{label:"视频标题",prop:"title"},{default:n(()=>[a(t(se),{modelValue:w.value.title,"onUpdate:modelValue":e[1]||(e[1]=s=>w.value.title=s),placeholder:"请输入视频标题",size:"large","prefix-icon":t(Il),clearable:""},null,8,["modelValue","prefix-icon"])]),_:1})]),_:1}),a(r,{xs:24,sm:12},{default:n(()=>[a(t(Q),{label:"视频分类",prop:"categoryId"},{default:n(()=>[a(t(_l),{modelValue:w.value.categoryId,"onUpdate:modelValue":e[2]||(e[2]=s=>w.value.categoryId=s),placeholder:"请选择分类",size:"large",style:{width:"100%"},clearable:""},{default:n(()=>[(m(!0),E(Se,null,Fe(Y.value,s=>(m(),D(t(hl),{key:s.value,label:s.text,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(t(Q),{label:"视频描述"},{default:n(()=>[a(t(se),{type:"textarea",modelValue:w.value.description,"onUpdate:modelValue":e[3]||(e[3]=s=>w.value.description=s),placeholder:"可选：输入视频简介、内容说明等",autosize:{minRows:3,maxRows:6},"show-word-limit":"",maxlength:"500"},null,8,["modelValue"])]),_:1})]),o("div",Te,[o("div",De,[a(t(k),null,{default:n(()=>[a(t(re))]),_:1}),e[11]||(e[11]=o("span",null,"视频文件",-1)),c.value?(m(),D(t(ie),{key:0,type:"success",size:"small",class:"file-tag"},{default:n(()=>e[10]||(e[10]=[T(" 已选择 ")])),_:1,__:[10]})):_("",!0)]),c.value?(m(),E("div",Oe,[o("div",We,[o("div",Ae,[a(t(k),{class:"file-icon"},{default:n(()=>[a(t(re))]),_:1}),o("div",Ke,[o("div",qe,R(B.value),1),o("div",Je,R(we(c.value.size)),1)])]),a(t(N),{type:"danger",icon:t(de),circle:"",onClick:_e,disabled:C.value,size:"small"},null,8,["icon","disabled"])]),C.value?(m(),E("div",Ge,[a(t(El),{percentage:L.value,"stroke-width":8,status:j.value?"exception":L.value===100?"success":"",class:"progress-bar"},null,8,["percentage","status"]),o("div",He,[o("span",{class:$e(["progress-text",{"error-text":j.value}])},R(I.value),3),le.value&&!j.value?(m(),E("span",Ze,R(le.value),1)):_("",!0)])])):_("",!0),b.value?(m(),E("div",Xe,[o("video",{ref_key:"videoElement",ref:U,src:b.value,controls:"",class:"video-preview",onLoadedmetadata:he},null,40,Qe),F.value>0?(m(),E("div",Ye,[a(t(yl),{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=s=>S.value=s),min:0,max:F.value,step:.1,onInput:Ve,class:"time-slider"},null,8,["modelValue","max"]),o("div",el,[o("span",null,R(te(S.value)),1),e[14]||(e[14]=o("span",null,"/",-1)),o("span",null,R(te(F.value)),1)]),a(t(N),{size:"small",onClick:X,type:"primary",icon:t(ce)},{default:n(()=>e[15]||(e[15]=[T(" 截取封面 ")])),_:1,__:[15]},8,["icon"])])):_("",!0)])):_("",!0)])):(m(),E("div",Ne,[a(t(ne),{class:"video-uploader",drag:"","show-file-list":!1,"before-upload":fe,"on-change":ge,"auto-upload":!1,accept:"video/*",disabled:C.value},{default:n(()=>[o("div",Le,[a(t(k),{class:"upload-icon"},{default:n(()=>[a(t(xl))]),_:1}),e[13]||(e[13]=o("div",{class:"upload-text"},[o("p",{class:"upload-title"},"拖拽视频文件到此处"),o("p",{class:"upload-hint"},"或点击选择文件")],-1)),o("div",je,[a(t(k),null,{default:n(()=>[a(t(ue))]),_:1}),e[12]||(e[12]=o("span",null,"支持 MP4、WebM 等格式，最大 2000MB",-1))])])]),_:1},8,["disabled"])]))]),o("div",ll,[o("div",tl,[a(t(k),null,{default:n(()=>[a(t(ve))]),_:1}),e[17]||(e[17]=o("span",null,"封面图片",-1)),M.value||y.value?(m(),D(t(ie),{key:0,type:"success",size:"small",class:"file-tag"},{default:n(()=>e[16]||(e[16]=[T(" 已设置 ")])),_:1,__:[16]})):_("",!0)]),o("div",ol,[y.value?_("",!0):(m(),E("div",al,[a(t(ne),{class:"cover-uploader",drag:"","show-file-list":!1,"before-upload":Ee,"on-change":ye,"auto-upload":!1,accept:"image/*",disabled:J.value||C.value||!c.value},{default:n(()=>[o("div",sl,[a(t(k),{class:"cover-icon"},{default:n(()=>[a(t(ve))]),_:1}),e[18]||(e[18]=o("div",{class:"cover-text"},[o("p",null,"点击或拖拽上传封面"),o("p",{class:"cover-hint"},"支持 JPG、PNG，建议 16:9 比例")],-1))])]),_:1},8,["disabled"]),c.value?_("",!0):(m(),E("div",nl,[a(t(k),null,{default:n(()=>[a(t(Ul))]),_:1}),e[19]||(e[19]=o("span",null,"请先上传视频，或从视频中截取封面",-1))]))])),y.value?(m(),E("div",il,[o("div",{class:"cover-preview-wrapper",onClick:ke},[o("img",{src:y.value,class:"cover-preview"},null,8,rl),o("div",ul,[a(t(k),null,{default:n(()=>[a(t(Fl))]),_:1}),e[20]||(e[20]=o("span",null,"点击查看大图",-1))])]),o("div",dl,[a(t(N),{size:"small",onClick:Z,icon:t(de),disabled:C.value},{default:n(()=>e[21]||(e[21]=[T(" 移除封面 ")])),_:1,__:[21]},8,["icon","disabled"]),c.value&&F.value>0?(m(),D(t(N),{key:0,size:"small",onClick:X,type:"primary",icon:t(ce),disabled:C.value},{default:n(()=>e[22]||(e[22]=[T(" 重新截取 ")])),_:1,__:[22]},8,["icon","disabled"])):_("",!0)])])):_("",!0)])]),o("div",cl,[a(t(N),{type:"primary",loading:x.value,onClick:xe,size:"large",disabled:!pe.value,class:"submit-btn"},{default:n(()=>[x.value?_("",!0):(m(),D(t(k),{key:0},{default:n(()=>[a(t(Sl))]),_:1})),o("span",null,R(x.value?"上传中...":"开始上传"),1)]),_:1},8,["loading","disabled"]),x.value?(m(),E("div",vl,[a(t(k),null,{default:n(()=>[a(t(ue))]),_:1}),e[23]||(e[23]=o("span",null,"上传过程中请勿关闭页面，支持断点续传",-1))])):_("",!0)])]),_:1},8,["model","rules","disabled"])]),_:1}),a(t(kl),{title:"封面预览",modelValue:q.value,"onUpdate:modelValue":e[5]||(e[5]=s=>q.value=s),width:"80%","close-on-click-modal":!0,class:"preview-dialog"},{default:n(()=>[o("div",pl,[y.value?(m(),E("img",{key:0,src:y.value,class:"preview-img",alt:"封面预览"},null,8,ml)):_("",!0)])]),_:1},8,["modelValue"])])}}},zl=Ue($l,[["__scopeId","data-v-e2c58b19"]]);export{zl as default};
