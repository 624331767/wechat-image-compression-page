<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF 压缩工具</title>
    <link
      rel="stylesheet"
      href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-plus/2.0.4/index.min.css"
    />
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/3.2.31/vue.global.min.js"></script>
    <script
      src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/axios/0.26.0/axios.min.js"
      type="application/javascript"
    ></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-plus/2.0.4/index.full.js"></script>

    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #f5f7fa;
      }

      .container {
        padding: 20px;
        max-width: 800px;
        margin: auto;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .demo-progress {
        margin-top: 20px;
      }

      .el-progress--line {
        margin-bottom: 15px;
        max-width: 600px;
      }

      .el-button + .el-button {
        margin-left: 10px;
      }

      textarea {
        width: 100%;
        max-width: 600px;
      }

      button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #42b983;
        color: white;
        border: none;
        cursor: pointer;
      }

      button:hover {
        background-color: #35495e;
      }
    </style>
  </head>

  <body>
    <div id="app" class="container">
      <el-container style="display: block">
        <el-header>
          <h1 style="text-align: center">PDF 压缩工具</h1>
        </el-header>
        <el-main>
          <el-card class="box-card">
            <template #header>
              <div class="card-header">
                <span>请按照提示操作以压缩您的 PDF 文件</span>
              </div>
            </template>
            <el-form :model="formData" ref="formRef" label-width="120px">
              <el-row :gutter="20">
                <el-col :span="24">
                  <el-form-item label="选择上传方式">
                    <el-radio-group v-model="uploadOption">
                      <el-radio label="file">文件上传</el-radio>
                      <el-radio label="url">输入 URL</el-radio>
                    </el-radio-group>
                  </el-form-item>
                </el-col>
                <el-col :span="24">
                  <transition name="fade">
                    <el-form-item
                      v-if="uploadOption === 'file'"
                      label="上传文件"
                    >
                      <el-upload
                        :action="action"
                        :before-upload="handleFileUpload"
                        :file-list="fileList"
                        :limit="1"
                        accept=".pdf"
                      >
                        <el-button type="primary">点击上传</el-button>
                      </el-upload>
                    </el-form-item>
                  </transition>
                  <transition name="fade">
                    <el-form-item v-if="uploadOption === 'url'" label="PDF URL">
                      <el-input
                        v-model="formData.url"
                        placeholder="输入 PDF 文件的 URL"
                      ></el-input>
                    </el-form-item>
                  </transition>
                </el-col>
                <el-col :span="24">
                  <el-form-item>
                    <el-button type="primary" @click="submitForm"
                      >压缩 PDF</el-button
                    >
                    <el-button type="default" @click="resetForm"
                      >重置</el-button
                    >
                  </el-form-item>
                </el-col>
              </el-row>
            </el-form>
            <el-alert
              v-if="result"
              :title="result"
              type="success"
              show-icon
            ></el-alert>
            <el-button v-if="result" type="primary" @click="downloadFile"
              >下载</el-button
            >

            <div
              class="demo-progress"
              v-if="uploadOption === 'file' && progressPercent > 0"
            >
              <el-progress
                :text-inside="true"
                :stroke-width="22"
                :percentage="progressPercent"
                status="warning"
              />
            </div>
          </el-card>
        </el-main>
      </el-container>

      <div style="display: none">
        <h1>发送消息到 UDP 服务</h1>
        <textarea
          v-model="message"
          placeholder="请输入消息"
          rows="4"
          cols="50"
        ></textarea
        ><br />
        <button @click="sendMessage">发送消息</button>
        <p v-if="response">响应: {{ response }}</p>
      </div>
    </div>

    <script>
      const { createApp, ref } = Vue;
      const { ElMessage, ElLoading } = ElementPlus;

      const App = {
        setup() {
          const error = ref("");
          const message = ref("");
          const response = ref("");
          const action = ref("");
          const formData = ref({
            file: null,
            url: "",
          });
          const fileList = ref([]);
          const uploadOption = ref("file");
          const result = ref("");
          const downloadUrl = ref("");
          let loadingInstance = null;
          const progressPercent = ref(0);

          // 文件选择
          const handleFileUpload = (file) => {
            fileList.value = [file];
            formData.value.file = file;
            formData.value.url = ""; // 清空 URL
            downloadUrl.value = "";
            result.value = "";
            return false; // 阻止自动上传
          };

          // 表单提交
          const submitForm = async () => {
            if (uploadOption.value === "file") {
              if (!formData.value.file) {
                ElMessage.error("请选择一个 PDF 文件");
                return;
              }

              try {
                const chunkSize = 1024 * 1024; // 每个分片大小为1MB
                const chunks = Math.ceil(formData.value.file.size / chunkSize);
                for (let i = 0; i < chunks; i++) {
                  const start = i * chunkSize;
                  const end = Math.min(
                    start + chunkSize,
                    formData.value.file.size
                  );
                  const chunk = formData.value.file.slice(start, end);

                  const payload = new FormData();
                  payload.append("file", chunk);
                  payload.append("chunkIndex", i.toString());
                  payload.append("totalChunks", chunks.toString());
                  payload.append("fileName", formData.value.file.name);

                  await axios.post("/compress/chunk", payload, {
                    onUploadProgress: (progressEvent) => {
                      progressPercent.value = Math.ceil(
                        ((i + progressEvent.loaded / progressEvent.total) /
                          chunks) *
                          100
                      );
                    },
                    headers: { "Content-Type": "multipart/form-data" },
                  });

                  // 如果是最后一个分片，则发起合并请求
                  if (i === chunks - 1) {
                    loadingInstance = ElLoading.service({
                      lock: true,
                      text: "处理中...",
                      background: "rgba(0, 0, 0, 0.7)",
                    });

                    const mergeResponse = await axios.post(
                      "/compress/merge",
                      {
                        fileName: formData.value.file.name,
                        totalChunks: chunks,
                      },
                      {
                        headers: { "Content-Type": "application/json" },
                      }
                    );
                    console.log(mergeResponse, "mergeResponse");

                    result.value = `压缩成功！下载链接: ${mergeResponse.data.data[0].fileUrl}`;
                    downloadUrl.value = mergeResponse.data.data[0].fileUrl;
                    progressPercent.value = 0;
                    ElMessage.success("PDF 压缩成功！");
                  }
                }
              } catch (error) {
                ElMessage.error(
                  `压缩失败: ${error.response?.data?.error || error.message}`
                );
                progressPercent.value = 0;
              } finally {
                loadingInstance?.close();
              }
            } else if (uploadOption.value === "url") {
              if (!formData.value.url) {
                ElMessage.error("请输入 PDF 文件的 URL");
                return;
              }

              try {
                loadingInstance = ElLoading.service({
                  lock: true,
                  text: "处理中...",
                  background: "rgba(0, 0, 0, 0.7)",
                });

                const response = await axios.post(
                  "/compress",
                  {
                    url: formData.value.url,
                  },
                  {
                    headers: { "Content-Type": "application/json" },
                  }
                );

                result.value = `压缩成功！下载链接: ${response.data.data[0].fileUrl}`;
                downloadUrl.value = response.data.data[0].fileUrl;
                ElMessage.success("PDF 压缩成功！");
              } catch (error) {
                ElMessage.error(
                  `压缩失败: ${error.response?.data?.error || error.message}`
                );
              } finally {
                loadingInstance?.close();
              }
            }
          };

          // 下载文件
          const downloadFile = () => {
            if (!downloadUrl.value) {
              ElMessage.error("暂无可下载文件");
              return;
            }

            axios({
              method: "get",
              url: downloadUrl.value,
              responseType: "blob",
            })
              .then((response) => {
                const blob = new Blob([response.data], {
                  type: "application/pdf",
                });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "compressed.pdf";
                link.click();
                URL.revokeObjectURL(link.href);
              })
              .catch((error) => {
                ElMessage.error(`下载失败: ${error.message}`);
              });
          };

          // 重置表单
          const resetForm = () => {
            formData.value.file = null;
            formData.value.url = "";
            fileList.value = [];
            result.value = "";
            downloadUrl.value = "";
            progressPercent.value = 0;
          };

          // 发送消息的函数
          const sendMessage = async () => {
            if (!message.value) {
              alert("请输入消息内容");
              return;
            }

            error.value = ""; // 清除之前的错误信息
            response.value = ""; // 清除之前的响应信息

            try {
              // 发送 POST 请求到 Node.js 服务
              const res = await axios.post("http://localhost:3000/send", {
                message: message.value,
              });

              // 如果后端返回了数据，显示消息
              if (res.status === 200) {
                response.value = res.data.message;
              } else {
                error.value = "服务器返回错误";
              }
              console.log(res.data); // 打印响应数据以便调试
            } catch (err) {
              console.error("请求失败:", err);
              // 提供详细的错误信息
              if (err.response) {
                error.value = `服务器错误: ${
                  err.response.data.message || err.message
                }`;
              } else {
                error.value = "请求失败，请检查网络连接";
              }
            }
          };

          return {
            formData,
            fileList,
            uploadOption,
            result,
            progressPercent,
            handleFileUpload,
            submitForm,
            downloadFile,
            resetForm,
            action,
            message,
            response,
            sendMessage,
            error,
          };
        },
      };

      createApp(App).use(ElementPlus).mount("#app");
    </script>
  </body>
</html>
